pipeline {
  agent any
  triggers {
     cron('*/10 * * * *')
  }
  stages {
    stage('Build') {
      environment {
        PLAYBOOK="dev-workers_playbook.yml"
        EXTRA_VARS="ansible_user=jenkins_bot"
      }
      steps {
        sh 'echo false_password > .vault_pass.txt'
        sshagent (credentials: ['galaxy-au-tools-jenkins-bot ssh key']) {
          withCredentials([file(credentialsId: 'infrastructure_vault_pass', variable: 'VAULT_PASS')]){
            sh '''
              source jenkins/utils.sh;
              activate_virtualenv;
              ansible-galaxy install -p roles -r requirements.yml --force;
              ansible-playbook -i hosts "$PLAYBOOK" \
                --extra-vars "$EXTRA_VARS" \
                --vault-password-file "$VAULT_PASS";
            '''
          }
        }
      }
    }
  }
}
